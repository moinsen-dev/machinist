#!/bin/bash
set -euo pipefail

# machinist restore script
# Generated: {{.Meta.CreatedAt}}
# Source: {{.Meta.SourceHostname}} ({{.Meta.SourceOSVersion}}, {{.Meta.SourceArch}})

LOGFILE="$HOME/.machinist/restore.log"
mkdir -p "$(dirname "$LOGFILE")"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOGFILE"
}

stage() {
    log "=== Stage: $1 ==="
}

log "machinist restore started"

{{if .Homebrew}}
{{template "homebrew" .Homebrew}}
{{end}}

{{if .Shell}}
{{template "shell" .Shell}}
{{end}}

{{if .GitRepos}}
{{template "git-repos" .GitRepos}}
{{end}}

{{if .Node}}
{{template "node" .Node}}
{{end}}

{{if .Python}}
{{template "python" .Python}}
{{end}}

{{if .Rust}}
{{template "rust" .Rust}}
{{end}}

{{if .VSCode}}
{{template "vscode" .VSCode}}
{{end}}

{{if .Cursor}}
{{template "cursor" .Cursor}}
{{end}}

{{if .MacOSDefaults}}
{{template "macos-defaults" .MacOSDefaults}}
{{end}}

{{if .Apps}}
{{template "apps" .Apps}}
{{end}}

{{if .Fonts}}
{{template "fonts" .Fonts}}
{{end}}

{{if .Folders}}
{{template "folders" .Folders}}
{{end}}

{{if or .Crontab .LaunchAgents}}
{{template "scheduled" .}}
{{end}}

log "machinist restore completed"
echo ""
echo "âœ“ Restore complete. Check $LOGFILE for details."
